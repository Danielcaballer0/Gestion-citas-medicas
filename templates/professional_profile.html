{% extends 'base.html' %}

{% block title %}{{ user.first_name }} {{ user.last_name }} - Perfil Profesional{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css">
<style>
    .available-slot {
        opacity: 0.7 !important;
    }
    .fc-day-today {
        background-color: rgba(var(--bs-primary-rgb), 0.05) !important;
    }
    .fc-col-header-cell {
        background-color: var(--bs-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Professional Info -->
        <div class="col-md-4 mb-4">
            <div class="card border-0 bg-dark shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-user-md fa-7x text-primary"></i>
                    </div>
                    <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                    
                    {% if professional.specialties %}
                        <div class="mb-3">
                            {% for specialty in professional.specialties %}
                                <span class="badge bg-primary me-1">{{ specialty.name }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% if professional.years_experience %}
                        <p><i class="fas fa-briefcase me-2"></i>{{ professional.years_experience }} años de experiencia</p>
                    {% endif %}
                    
                    {% if professional.accepts_insurance %}
                        <p><i class="fas fa-check-circle me-2 text-success"></i>Acepta seguros médicos</p>
                    {% else %}
                        <p><i class="fas fa-times-circle me-2 text-danger"></i>No acepta seguros médicos</p>
                    {% endif %}
                    
                    {% if professional.bio %}
                        <div class="mt-4">
                            <h5>Acerca de</h5>
                            <p class="text-start">{{ professional.bio }}</p>
                        </div>
                    {% endif %}
                    
                    {% if current_user.is_authenticated and current_user.is_client() %}
                        <a href="{{ url_for('client.book_appointment', professional_id=professional.id) }}" 
                           class="btn btn-primary mt-3">
                            <i class="fas fa-calendar-plus me-2"></i>Reservar Cita
                        </a>
                    {% elif not current_user.is_authenticated %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary mt-3">
                            <i class="fas fa-sign-in-alt me-2"></i>Inicia sesión para reservar
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Calendar and Availability -->
        <div class="col-md-8">
            <div class="card border-0 bg-dark shadow-sm mb-4">
                <div class="card-header bg-dark border-bottom">
                    <h4 class="mb-0">Horario de Atención</h4>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-dark">
                        <thead>
                            <tr>
                                <th>Día</th>
                                <th>Horario</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'] %}
                            {% for day_idx in range(7) %}
                                {% set has_schedule = false %}
                                {% set schedules_for_day = [] %}
                                {% for schedule in professional.schedules %}
                                    {% if schedule.day_of_week == day_idx %}
                                        {% set has_schedule = true %}
                                        {% set _ = schedules_for_day.append(schedule) %}
                                    {% endif %}
                                {% endfor %}
                                <tr class="{% if has_schedule %}bg-primary bg-opacity-10{% else %}bg-danger bg-opacity-10{% endif %}">
                                    <td>{{ days[day_idx] }}</td>
                                    <td>
                                        {% if schedules_for_day %}
                                            {% for schedule in schedules_for_day %}
                                                {{ schedule.start_time.strftime('%H:%M') }} - {{ schedule.end_time.strftime('%H:%M') }}{% if not loop.last %}<br>{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {% if current_user.is_authenticated and current_user.is_client() %}
                <div class="card border-0 bg-dark shadow-sm">
                    <div class="card-header bg-dark border-bottom">
                        <h4 class="mb-0">Próxima Disponibilidad</h4>
                    </div>
                    <div class="card-body">
                        <div id="calendar"></div>
                        <div class="text-center mt-3">
                            <a href="{{ url_for('client.book_appointment', professional_id=professional.id) }}" 
                               class="btn btn-primary">Ver Disponibilidad Completa</a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('calendar')) {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridWeek',
                headerToolbar: {
                    left: '',
                    center: 'title',
                    right: ''
                },
                height: 'auto',
                selectable: false,
                businessHours: [
                    {% for schedule in professional.schedules %}
                    {
                        daysOfWeek: [{{ schedule.day_of_week }}],
                        startTime: '{{ schedule.start_time.strftime("%H:%M") }}',
                        endTime: '{{ schedule.end_time.strftime("%H:%M") }}'
                    },
                    {% endfor %}
                ],
                eventSources: [
                    {
                        events: [
                            {% for schedule in professional.schedules %}
                            {
                                title: 'Disponible',
                                daysOfWeek: [{{ schedule.day_of_week }}],
                                startTime: '{{ schedule.start_time.strftime("%H:%M") }}',
                                endTime: '{{ schedule.end_time.strftime("%H:%M") }}',
                                color: 'var(--bs-primary)',
                                textColor: 'white',
                                display: 'background',
                                classNames: ['available-slot']
                            },
                            {% endfor %}
                        ]
                    }
                ],
                dayCellDidMount: function(info) {
                    // Verificar si el día tiene horarios disponibles
                    let hasSchedule = false;
                    let dayOfWeek = info.date.getDay(); // 0 = domingo, 1 = lunes, ..., 6 = sábado
                    
                    // Convertir al formato usado en la base de datos (0 = lunes, ..., 6 = domingo)
                    let dbDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    
                    {% for schedule in professional.schedules %}
                        if (dbDayOfWeek === {{ schedule.day_of_week }}) {
                            hasSchedule = true;
                        }
                    {% endfor %}
                    
                    // Aplicar color de fondo según disponibilidad
                    if (!hasSchedule) {
                        info.el.style.backgroundColor = 'rgba(var(--bs-danger-rgb), 0.1)'; // Rojo claro para no disponible
                    }
                }
            });
            calendar.render();
        }
    });
</script>
{% endblock %}
